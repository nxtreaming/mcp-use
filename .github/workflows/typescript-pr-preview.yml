name: TypeScript PR Preview

on:
  pull_request:
    branches:
      - main
      - canary
    paths:
      - "libraries/typescript/**"
      - ".github/workflows/typescript-pr-preview.yml"

permissions:
  contents: read
  pull-requests: write

jobs:
  preview:
    name: Publish PR Preview
    runs-on: ubuntu-latest
    outputs:
      pr-number: ${{ steps.pr-number.outputs.pr-number }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.6.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "pnpm"
          cache-dependency-path: libraries/typescript/pnpm-lock.yaml

      - name: Install Dependencies
        working-directory: libraries/typescript
        run: pnpm install --no-frozen-lockfile

      - name: Build Packages
        working-directory: libraries/typescript
        run: pnpm build

      - name: Publish Preview Packages
        run: pnpm dlx pkg-pr-new publish './libraries/typescript/packages/*' --pnpm

      - name: Get PR Number
        id: pr-number
        run: |
          echo "pr-number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT

  deno-test:
    name: Test with Deno (PR Preview)
    runs-on: ubuntu-latest
    needs: preview
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Create temporary deno.json with PR preview imports
        working-directory: libraries/typescript/packages/mcp-use/tests/deno
        # Note: Hybrid mapping to satisfy conflicting Zod requirements:
        # - SDK imports "zod/v3" and needs "z.custom" (available in Zod v3)
        # - Other deps import "zod/v4" and "zod/v4-mini"
        # - We map "zod/v3" to "zod@3.24.4" (aliasing v3 import to root v3 package)
        # - We use esm.sh for zod to match the PR preview environment
        run: |
          cat > deno.json << EOF
          {
            "imports": {
              "mcp-use/server": "https://esm.sh/pr/mcp-use/mcp-use@${{ needs.preview.outputs.pr-number }}/server?no-dts&external=zod",
              "mcp-use/client": "https://esm.sh/pr/mcp-use/mcp-use@${{ needs.preview.outputs.pr-number }}/client?no-dts&external=zod",
              "zod": "https://esm.sh/zod@3.24.4",
              "zod/v3": "https://esm.sh/zod@3.24.4",
              "zod/v4": "https://esm.sh/zod@4.2.0",
              "zod/v4-mini": "https://esm.sh/zod@4.2.0",
              "zod/v4/mini": "https://esm.sh/zod@4.2.0",
              "zod/v4/core": "https://esm.sh/zod@4.2.0"
            }
          }
          EOF
          echo "Generated deno.json with PR #${{ needs.preview.outputs.pr-number }} preview packages:"
          cat deno.json

      - name: Wait for esm.sh to pick up the package
        run: |
          echo "Waiting for esm.sh to pick up the preview package..."
          MAX_RETRIES=30
          RETRY_COUNT=0
          RETRY_DELAY=10

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -s -f -I "https://esm.sh/pr/mcp-use/mcp-use@${{ needs.preview.outputs.pr-number }}/server" > /dev/null 2>&1; then
              echo "✅ Package is available on esm.sh"
              break
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "Package not yet available, retrying in ${RETRY_DELAY}s... (attempt $RETRY_COUNT/$MAX_RETRIES)"
              sleep $RETRY_DELAY
            else
              echo "⚠️ Package didn't become available after ${MAX_RETRIES} attempts"
              echo "Proceeding with tests anyway..."
            fi
          done

      - name: Run Deno Tests
        working-directory: libraries/typescript/packages/mcp-use/tests/deno
        env:
          MCP_USE_ANONYMIZED_TELEMETRY: false
        run: |
          echo "Running Deno tests against PR #${{ needs.preview.outputs.pr-number }} preview packages..."
          deno test --no-check --allow-read --allow-env --allow-net
